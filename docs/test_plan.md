# Android Docker CLI Compatibility Test Plan

## 1. Test Objectives

Verify that the `android-docker-cli` tool is fully compatible with non-Docker Hub image registries (specifically `swr.cn-north-4.myhuaweicloud.com`), including image pulling, running, and management.

## 2. Test Environment

*   **Tool**: `android-docker-cli` (current version in project)
*   **Operating System**: Any Linux environment that supports `proot` and `curl`, preferably Termux on Android.
*   **Dependencies**: `python`, `proot`, `curl`, `tar`
*   **Test Image**: `swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/library/alpine:latest`

## 3. Test Cases

### 3.1. Case 1: Image Pull (`docker pull`)

*   **Steps**:
    1.  Execute command: `python docker_cli.py pull swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/library/alpine:latest`
    2.  (Optional) To verify forced refresh functionality, execute again: `python docker_cli.py pull --force swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/library/alpine:latest`
*   **Expected Results**:
    1.  Command executes successfully without errors.
    2.  Log shows "âœ“ Image pull successful".
    3.  In the `~/.docker_proot_cache/` directory, you can see a `.tar.gz` file and a `.info` file representing this image.
    4.  Execute `docker images` command to see cached image information.

### 3.2. Case 2: Container Run (Foreground Mode, `docker run`)

*   **Steps**:
    1.  Execute command: `python docker_cli.py run swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/library/alpine:latest echo "Hello from Huawei Cloud image"`
*   **Expected Results**:
    1.  Command executes successfully.
    2.  Terminal outputs "Hello from Huawei Cloud image".
    3.  Log shows "Container ... completed".
    4.  Since this is foreground non-persistent run, executing `docker ps -a` should not show a record of this container.

### 3.3. Case 3: Container Run (Interactive Mode, `docker run -it`)

*   **Steps**:
    1.  Execute command: `python docker_cli.py run -it swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/library/alpine:latest /bin/sh`
*   **Expected Results**:
    1.  Successfully enters the container's shell environment, with prompt changing to `#` or `$`.
    2.  In the shell, you can execute basic commands like `ls -l`, `pwd`, `cat /etc/os-release`.
    3.  After typing `exit`, you can exit the container normally.

### 3.4. Case 4: Container Run (Background Mode, `docker run -d`)

*   **Steps**:
    1.  Execute command: `python docker_cli.py run -d swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/library/alpine:latest sleep 60`
*   **Expected Results**:
    1.  Command returns immediately and outputs a container ID.
    2.  Log shows "Container ... started in background".
    3.  Execute `python docker_cli.py ps`, you can see a new container with status `running`.
    4.  After waiting about 1 minute, execute `python docker_cli.py ps -a` again, the container status should change to `exited`.

### 3.5. Case 5: Container Lifecycle Management (`ps`, `stop`, `start`, `rm`)

*   **Steps**:
    1.  Based on Case 3.4, start a background container: `python docker_cli.py run -d --name test-huawei swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/library/alpine:latest sleep 120`
    2.  View container status: `python docker_cli.py ps`
    3.  Stop container: `python docker_cli.py stop test-huawei`
    4.  View status again: `python docker_cli.py ps -a`
    5.  Start container: `python docker_cli.py start test-huawei`
    6.  View status again: `python docker_cli.py ps`
    7.  Remove container: `python docker_cli.py rm test-huawei`
    8.  Final status check: `python docker_cli.py ps -a`
*   **Expected Results**:
    1.  `ps` command correctly displays container running status (`running`, `exited`).
    2.  `stop` command successfully stops container, status changes to `exited`.
    3.  `start` command successfully starts stopped container, status changes back to `running`.
    4.  `rm` command successfully removes container, afterwards `ps -a` no longer shows this container.

### 3.6. Case 6: View Container Logs (`docker logs`)

*   **Steps**:
    1.  Start a background container to generate some output: `python docker_cli.py run -d --name log-test swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/library/alpine:latest sh -c 'echo "line 1"; sleep 1; echo "line 2"; sleep 1; echo "line 3"'`
    2.  Wait a few seconds, then view logs: `python docker_cli.py logs log-test`
    3.  (Optional) Test log following functionality: `python docker_cli.py logs -f log-test` (this command will keep running, need manual `Ctrl+C` to exit)
*   **Expected Results**:
    1.  `docker logs log-test` command should output logs already generated by container (e.g., "line 1", "line 2").
    2.  `docker logs -f log-test` command will first output existing logs, then block and print subsequent output in real-time (e.g., "line 3").
    3.  `Ctrl+C` can exit log following normally.
### 3.7. Case 7: Image Cleanup (`docker rmi`)

*   **Steps**:
    1.  Ensure no containers based on this image are running.
    2.  Execute command: `python docker_cli.py rmi swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/library/alpine:latest`
*   **Expected Results**:
    1.  Command executes successfully.
    2.  Corresponding `.tar.gz` and `.info` files in `~/.docker_proot_cache/` directory are deleted.
    3.  Execute `docker images` no longer shows this image.

### 3.8. Case 8: Image Startup Compatibility (Images requiring root startup then privilege drop)

*   **Purpose**: Cover the image startup path of "entry script will `chown` volume mount paths and run with privilege drop by supervisor/s6 etc. processes".
*   **Steps**:
    1.  Execute command: `docker run --name hass-panel -v ./data2:/config/hass-panel registry.cn-hangzhou.aliyuncs.com/hass-panel/hass-panel:latest`
    2.  If container runs in background mode, execute `docker logs hass-panel` to observe startup logs.
*   **Expected Results**:
    1.  No longer see startup failure caused by `Can't drop privilege as nonroot user`.
    2.  If `chown` behavior exists, it should not fail directly due to "non-root" (may still fail due to image itself, need to judge combined with logs).

## 4. Risks and Mitigation

*   **Risk**: Network issues causing image pull failure.
    *   **Mitigation**: Ensure test environment network is smooth and can access `swr.cn-north-4.myhuaweicloud.com`.
*   **Risk**: Huawei Cloud registry authentication mechanism not fully compatible with expected Docker Registry API V2.
    *   **Mitigation**: If authentication failure occurs, need to capture detailed `curl` output to analyze authentication flow, and may need to modify authentication logic in `create_rootfs_tar.py`.
## 5. Docker Compose Testing

### 5.1. Case 8: `docker-compose up -d`

*   **Steps**:
    1.  Create a file named `docker-compose.yml` with the following content:
        ```yaml
        version: '1.0'
        services:
          app:
            image: "swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/library/alpine:latest"
            container_name: "compose-test-app"
            command: "sh -c 'echo App started && sleep 300'"
          db:
            image: "swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/library/alpine:latest"
            container_name: "compose-test-db"
            command: "sh -c 'echo DB started && sleep 300'"
        ```
    2.  Execute command: `python docker_compose_cli.py up -d`
*   **Expected Results**:
    1.  Command executes successfully without errors.
    2.  Log shows starting `app` and `db` two services.
    3.  Execute `python docker_cli.py ps`, can see `compose-test-app` and `compose-test-db` two containers running.

### 5.2. Case 9: `docker-compose down`

*   **Steps**:
    1.  Ensure containers from Case 5.1 are running.
    2.  In the directory containing `docker-compose.yml`, execute command: `python docker_compose_cli.py down`
*   **Expected Results**:
    1.  Command executes successfully.
    2.  Log shows stopping and removing `compose-test-app` and `compose-test-db` containers.
    3.  Execute `python docker_cli.py ps -a`, no longer shows these two containers.
